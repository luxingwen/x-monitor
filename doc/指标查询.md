# 指标查询

## Prometheus配置

在 prometheus.yml 文件加入

```
job_name: 'x-monitor-data'
scrape_interval: 1s
static_configs:
  - targets: ['127.0.0.1:31079']
```

启动Prometheus

```
./prometheus --log.level=debug
```

查询指标

```
curl 0.0.0.0:31079/metrics
```

会看到如下输出

```
 ⚡ root@localhost  ~  curl 0.0.0.0:31079/metrics
# HELP node_load1 System 1m Load Average
# TYPE node_load1 gauge
node_load1{loadavg="load"} 0.01

# HELP node_load15 System 15m Load Average
# TYPE node_load15 gauge
node_load15{loadavg="load"} 0.070000000000000007

# HELP node_load5 System 5m Load Average
# TYPE node_load5 gauge
node_load5{loadavg="load"} 0.040000000000000001
```

## Prometheus查询

- 聚合操作：PromQL提供的聚合操作可以用来对当前的时间序列进行处理，生成新的一条时间序列。

- Prometheus数据类型

  - 标量：在PromQL中，标量是一个浮点型的数值，没有时序。
  - 区间向量：一组时间序列，每个时间序列包含一段时间范围内的样本数据。
  - 瞬时向量： 一组时间序列，每个时间序列包含单个样本，它们共享相同的时间戳。也就是说，表达式的返回值中只会包含该时间序列中的最新的一个样本值。而相应的这样的表达式称之为**瞬时向量表达式**。
  - 字符串。

- 按内存标签查询，{meminfo!=""}

- 按vmstat标签查询：{vmstat="page"}

- 按应用名查询：{dbapp="mysqld"}

- 查询cpu的jiffies，1分钟之内的数据：node_cpu_jiffies{cpu="cpu"}[1m]，如果Prometheus的采集时间间隔是3s，那么就会有20个数值。

- 以当前时间为准，查询1分钟之前的数据：node_cpu_jiffies{cpu="cpu"} offset 1m。

- 计算所有数据的和，例如计算所有cpu时间：sum(node_cpu_jiffies{cpu="cpu", mode!="total"})。将jiffies转换为秒，除以100即可：node_cpu_jiffies{cpu="cpu", mode="total"}/100。

- 查询主机cpu 20秒内的jiffies值，机器配置是8core，采集的时间间隔是10s，两次的值分别是54054753、54062744，**差值≈8000（jiffies）**，这样是符合理论计算的，机器的HZ是100，8core、10s的**jiffies = 8 * 10 * 100 = 8000(jiffies)**。

  ```
   ✘ ⚡ root@localhost  ~  getconf CLK_TCK
  100
  ```

  ![prometheus-timerange](./img/prometheus-timerange.jpg)

- increase函数，它的返回值的单位是 per-provided-time-window，计算结构就是单位时间内增长的数量。

  计算20秒的cpu总共增长了多少jiffies，expr：increase(node_cpu_jiffies{mode="total", cpu="cpu"}[20s])，查询结果15978≈16000（jiffies），**这也符合理论值：20 * 8 * 100 = 16000**。

  ![prometheus-increase](./img/prometheus-increase.jpg)

- 计算**cpu system**的占用率，计算结果是0.2%，公式：increase(node_cpu_jiffies{mode="system", cpu="cpu"}[20s])/16000。

  ![prometheus-system-usage](./img/prometheus-system-usage.jpg)

  这个是符合top的统计输出。

  ![top-cpu-sys-usage](./img/top-cpu-sys-usage.jpg)

- rate函数，计算每一秒增长率(per-second)，是所提供tw内的平均值。

  expr：rate(node_cpu_jiffies{mode="system", cpu="cpu"}[1m])/800，除以**800**是因为cpu有8个core，1s等于100jiffies，除以的结构就是相对于一个core的占有率百分比。

  ![prometheus-cpu-sys-usage-rate](./img/prometheus-cpu-sys-usage-rate.jpg)

- irate函数，它也是per-second增长率，是瞬时增长率。它只使用所提供tw内的最后两个采样，忽略掉前面的所有采样。

  现在配置的Prometheus的采样频率是10s一次，那么20s两次，这样用irate计算的都是瞬时的结果。

  expr：irate(node_cpu_jiffies{mode="system", cpu="cpu"}[20s])/800

- 查看主机cpu每秒的jiffies数量，expr：rate(node_cpu_jiffies{mode="total", cpu="cpu"}[20s]) ≈ 800

  ![prometheus-node-cpu-jiffies-1s](./prometheus-node-cpu-jiffies-1s.jpg)

## OS指标说明

### CPU指标

#### CPU负载

- node_load1
- node_load15
- node_load5

#### CPU PSI

- psi_cpu_loadavg_10secs

  说明：psi_cpu_loadavg_10secs = 0.03，最近10秒内任务因cpu资源不可用,0.03%的时间停顿等待CPU。如果avg大于40，也就是有40%的时间在等待CPU资源。

- psi_cpu_loadavg_60secs

- psi_cpu_loadavg_300secs

#### CPU使用率

- **node_cpu_sys_usage**

  expr：avg(irate(node_cpu_jiffies{mode="system", cpu!="cpu"}[40s])) by (instance, mode) / 100

  说明：cpu内核态占用率

- **node_cpu_usr_usage**

  expr：avg(irate(node_cpu_jiffies{mode="user", cpu!="cpu"}[40s])) by (instance, mode) / 100

  说明：cpu用户态占用率

- **node_cpu_iowait_usage**

  expr：avg(irate(node_cpu_jiffies{mode="iowait", cpu!="cpu"}[40s])) by (instance, mode) / 100

  说明：

- **node_cpu_idle_usage**

  expr：avg(irate(node_cpu_jiffies{mode="idle", cpu!="cpu"}[40s])) by (instance, mode) / 100

  说明：

- node_cpu_irq_usage

  expr：avg(irate(node_cpu_jiffies{mode="irq", cpu!="cpu"}[40s])) by (instance, mode) / 100

  说明：cpu硬中断占有率

- node_cpu_softirq_usage

  expr：avg(irate(node_cpu_jiffies{mode="softirq", cpu!="cpu"}[40s])) by (instance, mode) / 100

  说明：cpu软中断占有率

- node_cpu_nice_usage

  expr：avg(irate(node_cpu_jiffies{mode="nice", cpu!="cpu"}[40s])) by (instance, mode) / 100

  说明：Time spent in user mode with low priority

### 内存指标

- **node_memory_MemTotal_kilobytes**

  说明：物理内存总量，单位kB。

- **node_memory_MemUsed_kilobytes**

  expr：node_memory_MemTotal_kilobytes - node_memory_MemAvailable_kilobytes

  说明：已使用的物理内存数量，单位kB。真正可用的物理内存是包括free的、可回收的（cache/buffer、slab）。

- **node_memory_MemFree_kilobytes**

  说明：空闲的物理内存数量，单位kB。

- node_memory_Cached_kilobytes

  说明：In-memory cache for files read from the disk (the page cache).  Doesn't include SwapCached. 分配给文件缓冲区的内存,例如vi一个文件，就会将未保存的内容写到该缓冲区，使用vmtouch可以查看文件使用了多少内存cache。

- node_memory_Buffers_kilobytes

  说明：Relatively temporary storage for raw disk blocks that shouldn't get tremendously large，用来给块设备做缓存的内存。

- node_memory_SwapTotal_kilobytes

  说明：交换空间总大小，单位：kB。*Swapping*机制操作系统将物理内存页中的内容拷贝到硬盘上交换空间（Swap Space）以释放内存的过程。

- node_memory_SwapFree_kilobytes

  说明：Amount of swap space that is currently unused，查看swap设备信息用命令：swapon -s

- node_memory_SwapUsed_kilobytes

  说明：Amount of swap space that is currently used。

- **node_memory_MemUsed_usage**

  expr：(node_memory_MemTotal_kilobytes- node_memory_MemAvailable_kilobytes) / node_memory_MemTotal_kilobytes

  说明：物理内存使用率

- node_memory_SwapUsed_usage

  expr：node_memory_SwapUsed_kilobytes/ node_memory_SwapTotal_kilobytes

  说明：swap空间的使用率

- node_memory_Active_anon_kilobytes

  说明：The amount of anonymous and tmpfs/shmem memory, in kibibytes, that is in active use, or was in active use since the last time the system moved something to swap.活跃的匿名内存.

- node_memory_Active_file_kilobytes

  说明：The amount of file cache memory, in kibibytes, that is in active use, or was in active use since the last time the system reclaimed memory.活跃的文件使用内存

- node_memory_Active_kilobytes

  说明：The amount of memory, in kibibytes, that has been used more recently and is usually not reclaimed unless absolutely necessary.经常使用的高速缓冲存储器页面文件大小

- node_memory_AnonHugePages_kilobytes

  说明：The total amount of memory, in kibibytes, used by huge pages that are not backed by files and are mapped into userspace page tables. 匿名大页缓存

- node_memory_AnonPages_kilobytes

  说明：The total amount of memory, in kibibytes, used by pages that are not backed by files and are mapped into userspace page tables. 未映射页的内存/映射到用户空间的非文件页表大小

- node_memory_Bounce_kilobytes

  说明：The amount of memory, in kibibytes, used for the block device "bounce buffers". 在低端内存中分配一个临时buffer作为跳转，把位于高端内存的缓存数据复制到此处消耗的内存

- node_memory_CommitLimit_kilobytes

  说明：The total amount of memory currently available to be allocated on the system based on the overcommit ratio (`vm.overcommit_ratio`).  系统实际可分配内存

- node_memory_Committed_AS_kilobytes

  说明：The total amount of memory, in kibibytes, estimated to complete the workload. This value represents the worst case scenario value, and also includes swap memory. 系统当前已分配的内存

- **node_memory_Dirty_kilobytes**

  说明：The total amount of memory, in kibibytes, waiting to be written back to the disk. 等待被写回到磁盘的

- node_memory_HardwareCorrupted_kilobytes

  说明：The amount of memory, in kibibytes, with physical memory corruption problems, identified by the hardware and set aside by the kernel so it does not get used. 当系统检测到内存的硬件故障时删除掉的内存页的总量

- node_memory_HugePages_free

  说明：The total number of hugepages available for the system. *This statistic only appears on the x86, Itanium, and AMD64 architectures. *空闲的大页内存

- node_memory_HugePages_rsvd

  说明：The number of unused huge pages reserved for hugetlbfs. 已经被应用程序分配但尚未使用的大页内存

- node_memory_HugePages_surp

  说明：The number of surplus huge pages. 初始大页数与修改配置后大页数的差值

- node_memory_HugePages_used

  说明：

- node_memory_Inactive_anon_kilobytes

  说明：The amount of anonymous and tmpfs/shmem memory, in kibibytes, that is in active use, or was in active use since the last time the system moved something to swap. 不活跃的匿名内存

- node_memory_Inactive_file_kilobytes

  说明：The amount of file cache memory, in kibibytes, that is newly loaded from the disk, or is a candidate for reclaiming. 不活跃的文件使用内存

- node_memory_Inactive_kilobytes

  说明：The amount of memory, in kibibytes, that has been used less recently and is more eligible to be reclaimed for other purposes. 不经常使用的高速缓冲存储器文件大小

- node_memory_KernelStack_kilobytes

  说明：The amount of memory, in kibibytes, used by the kernel stack allocations done for each task in the system. 内核栈空间消耗的内存

- node_memory_Mapped_kilobytes

  说明：The memory, in kibibytes, used for files that have been mmaped, such as libraries. 映射文件内存

- node_memory_Mlocked_kilobytes

  说明：The total amount of memory, in kibibytes, that is not evictable because it is locked into memory by user programs. 系统调用 mlock 家族允许程序在物理内存上锁住它的部分或全部地址空间。这将阻止Linux 将这个内存页调度到交换空间（swap space），即使该程序已有一段时间没有访问这段空间

- node_memory_NFS_Unstable_kilobytes

  说明：The amount, in kibibytes, of NFS pages sent to the server but not yet committed to the stable storage.

- node_memory_PageTables_kilobytes

  说明：The total amount of memory, in kibibytes, dedicated to the lowest page table level. 管理内存分页的索引表的大小

- node_memory_Percpu_kilobytes

  说明：

- node_memory_SReclaimable_kilobytes

  说明：The part of Slab that can be reclaimed, such as caches. 可收回slab内存

- node_memory_SUnreclaim_kilobytes

  说明：The part of Slab that cannot be reclaimed even when lacking memory. 不可收回slab内存

- node_memory_ShmemHugePages_kilobytes

  说明：

- node_memory_Shmem_kilobytes

  说明：The total amount of memory, in kibibytes, used by shared memory (shmem) and tmpfs. 已经被分配的共享内存

- node_memory_Slab_kilobytes

  说明：The total amount of memory, in kibibytes, used by the kernel to cache data structures for its own use. 内核数据结构缓存

- node_memory_Unevictable_kilobytes

  说明：The amount of memory, in kibibytes, discovered by the pageout code, that is not evictable because it is locked into memory by user programs.不能被释放的内存页

- node_memory_VmallocUsed_kilobytes

  说明：The total amount of memory, in kibibytes, of used virtual address space.已经被使用的虚拟内存

- node_memory_WritebackTmp_kilobytes

  说明：The amount of memory, in kibibytes, used by FUSE for temporary writeback buffers.FUSE用于临时写回缓冲区的内存

- node_memory_Writeback_kilobytes

  说明：The total amount of memory, in kibibytes, actively being written back to the disk. 正在被写回的

#### 内存 PSI

- node_psi_io_full_loadavg_10secs

  说明：最近10秒内**所有的**任务因等待io资源被停顿的百分比。所有任务等待io资源时间重合。

- node_psi_io_some_loadavg_10secs

  说明：最近10秒内**一个或多个**任务因等待io资源被停顿的百分比。表明了由于缺乏io资源而造成至少一个任务的停顿。

- node_psi_io_full_loadavg_60secs

- node_psi_io_some_loadavg_60secs

- node_psi_io_full_loadavg_300secs

- node_psi_io_some_loadavg_300secs

### 文件系统指标

- node_filesystem_size_bytes

  说明：node_filesystem_size_bytes Filesystem size in bytes. 文件系统空间总大小，单位：字节

- node_filesystem_free_bytes

  说明：node_filesystem_free_bytes Filesystem free space in bytes. 文件系统空闲空间大小，单位：字节，（超级用户可获取的）

- node_filesystem_avail_bytes

  说明：node_filesystem_avail_bytes Filesystem space available to non-root users in bytes. 文件系统可用空间大小，单位：字节，（非超级用户可获取的）。

- node_filesystem_files

  说明：node_filesystem_files Filesystem total file nodes. 文件系统inode总数

- node_filesystem_files_free

  说明：node_filesystem_files_free Filesystem total free file nodes. 文件系统inode空闲数

- node_filesystem_readonly

  说明：node_filesystem_readonly Filesystem read-only status. 文件系统是否为只读

- node_filesystem_device_error

  说明：node_filesystem_device_error Whether an error occurred while getting statistics for the given device. 文件系统是否损坏

- node_filesystem_used_space_usage

  expr：1 - node_filesystem_free_bytes/node_filesystem_size_bytes

  说明：磁盘空间使用率，df -h的Use%

- node_filesystem_used_inode_usage

  expr：1 - node_filesystem_files_free/node_filesystem_files

  说明：磁盘使用文件系统的inode使用率

### 磁盘指标

- node_disk_writes_total_bytes

  说明：The total number of bytes written successfully.

- node_disk_writes_merged_total_count

  说明：The number of writes merged. 写操作的合并次数。

- node_disk_writes_completed_total_count

  说明：The total number of writes completed successfully. 写操作成功的次数

- node_disk_write_spent_total_seconds

  说明：This is the total number of seconds spent by all writes. 所有的写操作总共花费的时间（单位：秒）。

- node_disk_reads_merged_total_count

  说明：The total number of reads merged.

- node_disk_reads_completed_total_count

  说明：The total number of reads completed successfully.

- node_disk_read_total_bytes

  说明：The total number of bytes read successfully.

- node_disk_read_spent_total_seconds

  说明：The total number of seconds spent by all reads. 所有的读操作总共花费的时间（单位：秒）。

- **node_disk_iostat_write_requests_per_sec**

  说明：The number (after merges) of write requests completed per second for the device，每秒的写操作次数，iostat的w/s。

- **node_disk_iostat_write_request_merged_per_sec**

  说明：The number of write requests merged per second that were queued to the device，每秒写操作合并的次数，iostat的wrqm/s。

- **node_disk_iostat_write_kilobytes_per_sec**

  说明：The number of kilobytes written to the device per second.每秒写入设备千字节数，iostat的wkB/s。

- **node_disk_iostat_w_await**

  说明：The average time (in milliseconds) for write requests issued to the deviceto be served. This includes the time spent by the requests in queue and the time spent servicing them.每个写操作的耗时（毫秒）

- **node_disk_iostat_util**

  说明：Percentage of elapsed time during which I/O requests were issued to the device (bandwidth utilization for the device). 该硬盘设备的繁忙比率

- **node_disk_iostat_tps**

  说明：Indicate the number of transfers per second that were issued to the device. 硬盘的tps。

- **node_disk_iostat_read_requests_per_sec**

  说明：The number (after merges) of read requests completed per second for the device. iostat的r/s。

- **node_disk_iostat_read_request_merged_per_sec**

  说明：The number of read requests merged per second that were queued to the device. iostat的rrqm/s。

- **node_disk_iostat_read_kilobytes_per_sec**

  说明：The number of kilobytes read from the device per second. iostat的rkB/s

- **node_disk_iostat_r_await**

  说明：The average time (in milliseconds) for read requests issued to the device to be served. This includes the time spent by the requests in queue and the time spent servicing them. 每个读操作的耗时（毫秒）

- **node_disk_iostat_await**

  说明：The average time (in milliseconds) for I/O requests issued to the device to be served. This includes the time spent by the requests in queue and the time spent servicing them." 每個I/O平均所需的時間（毫秒）

- node_disk_iostat_avg_request_write_kilobytes

  说明：The average size (in kilobytes) of the write requests that were issued to the device. iostat的**wareq-sz**，平均每个写请求写入的千字节数。

- node_disk_iostat_avg_request_read_kilobytes

  说明：The average size (in kilobytes) of the read requests that were issued to the device. iostat的**rareq-se**，平均每个读请求读出的千字节数。

- node_disk_iostat_avg_request_kilobytes

  说明：The average size (in kilobytes) of the I/O requests that were issued to the device. iostat的**areq_sz**，平均每个io请求的千字节数。

- **node_disk_iostat_aqu_sz**

  说明：The average queue length of the requests that were issued to the device. 平均未完成的I/O請求數量，在请求队列中的数量。

- node_disk_io_time_weighted_total_seconds

  说明：The weighted # of seconds spent doing I/Os. 输入/输出操作花费的加权毫秒数， 加权，花在I/O操作上的毫秒数，在每次I/O开始，I/O结束，I/O合并时这个域都会增加。这可以给I/O完成时间和存储那些可以累积的提供一个便利的测量标准。

- node_disk_io_spent_total_seconds

  说明：Total seconds spent doing I/Os. 执行I/O所花费的秒数

- **node_disk_io_now**

  说明：The number of I/Os currently in progress. 正在处理的I/O請求數，-I/O的當前進度，只有這個域應該是0。當請求被交給適當的request_queue_t時增加和請求完成時減小。

- node_disk_discards_merged_total_count

  说明：The total number of discards merged.

- node_disk_discards_completed_total_count

  说明：The total number of discards completed successfully.

- node_disk_discard_spent_total_seconds

  说明：This is the total number of seconds spent by all discards.

- node_discarded_sectors_total_count

  说明：The total number of sectors discarded successfully.

### 网络指标

#### 网络设备

- node_network_receive_bytes_per_second

  expr：sum(rate(node_network_receive_bytes_total{instance="127.0.0.1:31079"}[40s])) by (instance, device)

  说明：网卡每秒接收字节速率，这里用sum是为了聚合生成新的指标，带上指定标签。

- node_network_transmit_bytes_per_second

  expr：sum(rate(node_network_transmit_bytes_total{instance="127.0.0.1:31079"}[40s])) by (instance, device)

  说明：网卡每秒发送字节速率

- node_network_virtual_device

  说明：是否是虚拟网卡，1：是，0：不是

- node_network_up

  说明：网卡运行状态，1：运行，0：停止

- node_network_transmit_packets_total

  说明：Number of packets successfully transmitted. For hardware interfaces counts packets which host was able to successfully hand over to the device, which does not necessarily mean that packets had been successfully transmitted out of the device, only that device acknowledged it copied them out of host memory. 接口发送数据包总数

- node_network_transmit_fifo_total

  说明：The number of transmit FIFO buffer errors. FIFO缓冲区错误的数量

- node_network_transmit_errs_total

  说明：Total number of transmit problems. This counter must include events counter by tx_aborted_errors, tx_carrier_errors, tx_fifo_errors, tx_heartbeat_errors, tx_window_errors and other errors not otherwise counted. 由设备驱动程序检测到的发送错误的总数

- node_network_transmit_drop_total

  说明：Number of packets dropped on their way to transmission, e.g. due to lack of resources.  设备驱动程序丢弃的发送数据包总数

- node_network_transmit_compressed_total

  说明：Number of transmitted compressed packets. This counters is only meaningful for interfaces which support packet compression (e.g. CSLIP, PPP). 设备驱动程序发送压缩数据包数

- node_network_transmit_colls_total

  说明：Number of collisions during packet transmissions. 接口上检测到的冲突数

- node_network_transmit_carrier_total

  说明：Number of frame transmission errors due to loss of carrier during transmission. 由设备驱动程序检测到的载波损耗的数量

- **node_network_transmit_bytes_total**

  说明：

- node_network_speed

  说明：

- node_network_receive_packets_total

  说明：

- node_network_receive_multicast_total

  说明：

- node_network_receive_frame_total

  说明：

- node_network_receive_fifo_total

  说明：

- node_network_receive_errs_total

  说明：

- node_network_receive_drop_total

  说明：

- node_network_receive_compressed_total

  说明：

- node_network_receive_bytes_total

  说明：

- node_network_mtu_bytes

  说明：

- node_network_info

  说明：

- node_network_transmit_queue_length

  说明：

#### 网络协议

##### TCP

##### IP

##### UDP

### CGroup指标

### 主机参数

- node_cpu_count

  expr：count(node_cpu_jiffies{mode="system", cpu!="cpu"}) by (instance, mode)

  说明：主机cpu核数。

## 附录

- [使用PSI（Pressure Stall Information）监控服务器资源_Linux_swordholder_InfoQ写作社区](https://xie.infoq.cn/article/931eee27dabb0de906869ba05)

- [Really used memory on GNU/Linux - CalimeroTeknik's Blag (free.fr)](http://calimeroteknik.free.fr/blag/?article20/really-used-memory-on-gnu-linux)

- [proc(5) - Linux manual page (man7.org)](https://man7.org/linux/man-pages/man5/proc.5.html)

- [prometheus常用表达式_运维日记的博客-CSDN博客_prometheus表达式](https://blog.csdn.net/weixin_44946147/article/details/123678989?spm=1001.2101.3001.6650.12&utm_medium=distribute.pc_relevant.none-task-blog-2~default~CTRLIST~default-12-123678989-blog-105121525.pc_relevant_default&depth_1-utm_source=distribute.pc_relevant.none-task-blog-2~default~CTRLIST~default-12-123678989-blog-105121525.pc_relevant_default&utm_relevant_index=17)

- [Prometheus监控运维实战七： 主机监控指标_运维老兵Alex的技术博客_51CTO博客](https://blog.51cto.com/u_14065119/3698192)

- [/proc/meminfo之谜 | Linux Performance](http://linuxperf.com/?p=142)

  
  
  






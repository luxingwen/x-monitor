# 指标查询

## Prometheus配置

在 prometheus.yml 文件加入

```
job_name: 'x-monitor-data'
scrape_interval: 1s
static_configs:
  - targets: ['127.0.0.1:31079']
```

启动Prometheus

```
./prometheus --log.level=debug
```

查询指标

```
curl 0.0.0.0:31079/metrics
```

会看到如下输出

```
 ⚡ root@localhost  ~  curl 0.0.0.0:31079/metrics
# HELP node_load1 System 1m Load Average
# TYPE node_load1 gauge
node_load1{loadavg="load"} 0.01

# HELP node_load15 System 15m Load Average
# TYPE node_load15 gauge
node_load15{loadavg="load"} 0.070000000000000007

# HELP node_load5 System 5m Load Average
# TYPE node_load5 gauge
node_load5{loadavg="load"} 0.040000000000000001
```

## Prometheus查询

- 按内存标签查询，{meminfo!=""}

- 按vmstat标签查询：{vmstat="page"}

- 按应用名查询：{dbapp="mysqld"}

- 查询cpu的jiffies，1分钟之内的数据：node_cpu_jiffies{cpu="cpu"}[1m]，如果Prometheus的采集时间间隔是3s，那么就会有20个数值。

- 以当前时间为准，查询1分钟之前的数据：node_cpu_jiffies{cpu="cpu"} offset 1m。

- 计算所有数据的和，例如计算所有cpu时间：sum(node_cpu_jiffies{cpu="cpu", mode!="total"})。将jiffies转换为秒，除以100即可：node_cpu_jiffies{cpu="cpu", mode="total"}/100。

- 查询主机cpu 20秒内的jiffies值，机器配置是8core，采集的时间间隔是10s，两次的值分别是54054753、54062744，**差值≈8000（jiffies）**，这样是符合理论计算的，机器的HZ是100，8core、10s的**jiffies = 8 * 10 * 100 = 8000(jiffies)**。

  ```
   ✘ ⚡ root@localhost  ~  getconf CLK_TCK
  100
  ```

  ![prometheus-timerange](./img/prometheus-timerange.jpg)

- increase函数，它的返回值的单位是 per-provided-time-window，计算结构就是单位时间内增长的数量。

  计算20秒的cpu总共增长了多少jiffies，expr：increase(node_cpu_jiffies{mode="total", cpu="cpu"}[20s])，查询结果15978≈16000（jiffies），**这也符合理论值：20 * 8 * 100 = 16000**。

  ![prometheus-increase](./img/prometheus-increase.jpg)

- 计算**cpu system**的占用率，计算结果是0.2%，公式：increase(node_cpu_jiffies{mode="system", cpu="cpu"}[20s])/16000。

  ![prometheus-system-usage](./img/prometheus-system-usage.jpg)

  这个是符合top的统计输出。

  ![top-cpu-sys-usage](./img/top-cpu-sys-usage.jpg)

- rate函数，计算每一秒增长率(per-second)，是所提供tw内的平均值。

  expr：rate(node_cpu_jiffies{mode="system", cpu="cpu"}[1m])/800，除以**800**是因为cpu有8个core，1s等于100jiffies，除以的结构就是相对于一个core的占有率百分比。

  ![prometheus-cpu-sys-usage-rate](./img/prometheus-cpu-sys-usage-rate.jpg)

- irate函数，它也是per-second增长率，是瞬时增长率。它只使用所提供tw内的最后两个采样，忽略掉前面的所有采样。

  现在配置的Prometheus的采样频率是10s一次，那么20s两次，这样用irate计算的都是瞬时的结果。

  expr：irate(node_cpu_jiffies{mode="system", cpu="cpu"}[20s])/800

- 查看主机cpu每秒的jiffies数量，expr：rate(node_cpu_jiffies{mode="total", cpu="cpu"}[20s]) ≈ 800

  ![prometheus-node-cpu-jiffies-1s](./prometheus-node-cpu-jiffies-1s.jpg)

## OS指标explain

### CPU指标

#### CPU负载

- metric：node_load1
- metric：node_load15
- metric：node_load5

#### CPU PSI

- metric：psi_cpu_loadavg_10secs

  explain：psi_cpu_loadavg_10secs = 0.03，最近10秒内任务因cpu资源不可用,0.03%的时间停顿等待CPU。如果avg大于40，也就是有40%的时间在等待CPU资源。

- metric：psi_cpu_loadavg_60secs

- metric：psi_cpu_loadavg_300secs

#### CPU使用率

- metric：node_cpu_sys_usage

  expr：avg(irate(node_cpu_jiffies{mode="system", cpu!="cpu"}[40s])) by (instance, mode) / 100

  explain：cpu内核态占用率

- metric：node_cpu_usr_usage

  expr：avg(irate(node_cpu_jiffies{mode="user", cpu!="cpu"}[40s])) by (instance, mode) / 100

  explain：cpu用户态占用率

- metric：node_cpu_iowait_usage

  expr：avg(irate(node_cpu_jiffies{mode="iowait", cpu!="cpu"}[40s])) by (instance, mode) / 100

  explain：

- metric：node_cpu_idle_usage

  expr：avg(irate(node_cpu_jiffies{mode="idle", cpu!="cpu"}[40s])) by (instance, mode) / 100

  explain：

- metric：node_cpu_irq_usage

  expr：avg(irate(node_cpu_jiffies{mode="irq", cpu!="cpu"}[40s])) by (instance, mode) / 100

  explain：cpu硬中断占有率

- metric：node_cpu_softirq_usage

  expr：avg(irate(node_cpu_jiffies{mode="softirq", cpu!="cpu"}[40s])) by (instance, mode) / 100

  explain：cpu软中断占有率

- metric：node_cpu_nice_usage

  expr：avg(irate(node_cpu_jiffies{mode="nice", cpu!="cpu"}[40s])) by (instance, mode) / 100

  explain：Time spent in user mode with low priority

### 内存指标

- node_memory_total_kilobytes

  explain：物理内存总量，单位kB。

- node_memory_used_kilobytes

  expr：node_memory_total_kilobytes - node_memory_available_kilobytes

  explain：已使用的物理内存数量，单位kB。

- node_memory_free_kilobytes

  explain：空闲的物理内存数量

- node_memory_cached_kilobytes

  explain：In-memory cache for files read from the disk (the page cache).  Doesn't include SwapCached. 分配给文件缓冲区的内存,例如vi一个文件，就会将未保存的内容写到该缓冲区，使用vmtouch可以查看文件使用了多少内存cache。

- node_memory_buffers_kilobytes

  explain：Relatively temporary storage for raw disk blocks that shouldn't get tremendously large，用来给块设备做缓存的内存。

- node_memory_swap_free_kilobytes

  explain：Amount of swap space that is currently unused，查看swap设备信息用命令：swapon -s

- node_memory_swap_used_kilobytes

  explain：Amount of swap space that is currently used。

- node_memory_used_usage

  expr：(node_memory_total_kilobytes - node_memory_available_kilobytes) / node_memory_total_kilobytes

  explain：物理内存使用率

- node_memory_swap_used_usage

  expr：node_memory_swap_used_kilobytes / (node_memory_swap_used_kilobytes + node_memory_swap_free_kilobytes)

  explain：swap的使用率

#### 内存 PSI

- node_psi_io_full_loadavg_10secs

  explain：最近10秒内**所有的**任务因等待io资源被停顿的百分比。所有任务等待io资源时间重合。

- node_psi_io_some_loadavg_10secs

  explain：最近10秒内**一个或多个**任务因等待io资源被停顿的百分比。表明了由于缺乏io资源而造成至少一个任务的停顿。

- node_psi_io_full_loadavg_60secs

- node_psi_io_some_loadavg_60secs

- node_psi_io_full_loadavg_300secs

- node_psi_io_some_loadavg_300secs

### 文件系统指标

- node_filesystem_size_bytes

  explain：node_filesystem_size_bytes Filesystem size in bytes.

- node_filesystem_free_bytes

  explain：node_filesystem_free_bytes Filesystem free space in bytes.

- node_filesystem_avail_bytes

  explain：node_filesystem_avail_bytes Filesystem space available to non-root users in bytes.

- node_filesystem_files

  explain：node_filesystem_files Filesystem total file nodes.

- node_filesystem_files_free

  explain：node_filesystem_files_free Filesystem total free file nodes.

- node_filesystem_readonly

  explain：node_filesystem_readonly Filesystem read-only status. 文件系统是否为只读

- node_filesystem_device_error

  explain：node_filesystem_device_error Whether an error occurred while getting statistics for the given device. 文件系统是否损坏

- node_filesystem_used_space_usage

  expr：1 - node_filesystem_free_bytes/node_filesystem_size_bytes

  explain：磁盘空间使用率，df -h的Use%

- node_filesystem_used_inode_usage

  expr：1 - node_filesystem_files_free/node_filesystem_files

  explain：磁盘使用文件系统的inode使用率

### 磁盘指标

- node_disk_written_bytes_total
- node_disk_writes_merged_total
- node_disk_writes_completed_total

### 网络指标

#### 网络设备

- node_network_receive_bytes_per_second

  expr：sum(rate(node_network_receive_bytes_total{job="x-monitor-data"}[40s])) by (instance, device)

  explain：网卡每秒接收字节速率

- node_network_transmit_bytes_per_second

  expr：sum(rate(node_network_transmit_bytes_total{job="x-monitor-data"}[40s])) by (instance, device)

  explain：网卡每秒发送字节速率

#### 网络协议

##### TCP

##### IP

##### UDP

### CGroup指标

### 主机传统参数监控

## 附录

- [使用PSI（Pressure Stall Information）监控服务器资源_Linux_swordholder_InfoQ写作社区](https://xie.infoq.cn/article/931eee27dabb0de906869ba05)

- [Really used memory on GNU/Linux - CalimeroTeknik's Blag (free.fr)](http://calimeroteknik.free.fr/blag/?article20/really-used-memory-on-gnu-linux)

- [proc(5) - Linux manual page (man7.org)](https://man7.org/linux/man-pages/man5/proc.5.html)

- [prometheus常用表达式_运维日记的博客-CSDN博客_prometheus表达式](https://blog.csdn.net/weixin_44946147/article/details/123678989?spm=1001.2101.3001.6650.12&utm_medium=distribute.pc_relevant.none-task-blog-2~default~CTRLIST~default-12-123678989-blog-105121525.pc_relevant_default&depth_1-utm_source=distribute.pc_relevant.none-task-blog-2~default~CTRLIST~default-12-123678989-blog-105121525.pc_relevant_default&utm_relevant_index=17)

- [Prometheus监控运维实战七： 主机监控指标_运维老兵Alex的技术博客_51CTO博客](https://blog.51cto.com/u_14065119/3698192)

  
  
  






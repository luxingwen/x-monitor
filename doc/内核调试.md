# 内核调试

## 安装、升级内核

### 启用ELRepo仓库

```
# rpm --import https://www.elrepo.org/RPM-GPG-KEY-elrepo.org
# rpm -Uvh https://www.elrepo.org/elrepo-release-7.el7.elrepo.noarch.rpm
```

### 查看可用的系统内核

```
yum --enablerepo="elrepo-kernel" list --showduplicates | sort -r | grep kernel
```

### 安装lt内核

```
yum --enablerepo=elrepo-kernel install kernel-ml
```

`--enablerepo` 选项开启 CentOS 系统上的指定仓库。默认开启的是 `elrepo`，这里用 `elrepo-kernel` 替换。

### 安装debuginfo内核

```
yum install --enablerepo=base-debuginfo -y kernel-devel$(uname −r) kernel−debuginfo−$(uname -r) kernel-debuginfo-common$(uname −m)−$(uname -r)
yum install --enablerepo=base-debuginfo -y kernel-debuginfo-$(uname -r)
```

内核调试需要带debug的vmlinux，一般都需要安装debug.debuginfo包，为了搭建测试环境，我从这里下载对应的内核。

[Index of /c7-kernels.x86_64/kernel/20191121160255/4.19.84-300.el7.x86_64 (centos.org)](https://buildlogs.centos.org/c7-kernels.x86_64/kernel/20191121160255/4.19.84-300.el7.x86_64/)

```
 ⚡ root@localhost  /  find . -name vmlinux
./usr/lib/debug/usr/lib/modules/4.19.84-300.el7.x86_64+debug/vmlinux
./usr/lib/debug/usr/lib/modules/4.19.84-300.el7.x86_64/vmlinux
 ⚡ root@localhost  /  grubby --info=ALL
index=0
kernel=/boot/vmlinuz-4.19.84-300.el7.x86_64+debug
args="ro crashkernel=1G-2G:192M,2G-4G:320M,4G-32G:512M,32G-64G:1024M,64G-128G:2048M,128G-:4096M rd.lvm.lv=centos/root rd.lvm.lv=centos/swap rhgb quiet LANG=en_US.UTF-8"
root=/dev/mapper/centos-root
initrd=/boot/initramfs-4.19.84-300.el7.x86_64+debug.img
title=CentOS Linux (4.19.84-300.el7.x86_64+debug) 7 (Core)
index=1
```

/boot/vmlinuz-4.19.84-300.el7.x86_64+debug把这个内核作为启动内核。

## Kdump

kdump是内核崩溃的时候，用来转存运行内存的一个工具。系统一旦崩溃，内核就没法工作了，这个时候将由kdump提供一个用于捕获当前运行信息的内核，该内核会将此时内存中的所有运行状态和数据信息收集到一个dump core文件中以便之后分析崩溃原因。一旦内存信息收集完成，可以让系统自动重启。

### 工作原理

当内核发生panic时，内核依靠kexec机制在预先保留的内存区域快速重启一个新的内核实例，预留内存区域大小可以通过内核启动参数crashkernel指定。

为了实现双内核布局，kdump在内核崩溃后立即使用**kexec引导转储捕获内核（capture kernel）**，使用kexec引导“覆盖”当前运行的内核。kexec（kernel execution）是linux内核的一种机制，其允许从当前运行的内核启动新内核。kexec会跳过由系统固件执行的引导加载程序阶段和硬件初始化阶段，直接将新内核加载到主内存并立即开始执行。

![kdump原理架构](./kdump原理架构.jpg)

![kdump-complete-flow](./kdump-complete-flow.jpg)

Kdump在内核学习时非常有用，如果我们需要了解内核运行状态或结构详情也可以使用kdump进行转储，后续使用Crash工具对照源码进行分析总结。

### 安装、配置

#### 安装kdump

检查kdump是否已经安装

```
rpm -q kexec-tools
```

如果没有安装，执行

```
yum install kexec-tools
```

评估需要多大的磁盘空间保存crash dump file，这感觉和物理内存大小一致。

```
[root@VM-0-8-centos crash]# makedumpfile --mem-usage /proc/kcore

TYPE		PAGES			EXCLUDABLE	DESCRIPTION
----------------------------------------------------------------------

ZERO		122466          	yes		Pages filled with zero
NON_PRI_CACHE	77566           	yes		Cache pages without private flag
PRI_CACHE	44617           	yes		Cache pages with private flag
USER		50293           	yes		User process pages
FREE		32981           	yes		Free pages
KERN_DATA	176823          	no		Dumpable kernel data 
```

#### 配置内核启动参数crashkernel

```
[root@VM-0-8-centos bpf-examples]# grubby --update-kernel=/boot/vmlinuz-5.14.0-86.el9.x86_64+debug --args=crashkernel=1G-2G:192M,2G-4G:320M,4G-32G:512M,32G-64G:1024M,64G-128G:2048M,128G-:4096M
```

系统重启后，可以在dmesg中查看相关信息：

```
[root@VM-0-8-centos ~]# dmesg -T | grep -i crash
[Mon Jun 27 15:10:44 2022] Command line: BOOT_IMAGE=(hd0,msdos1)/boot/vmlinuz-5.14.0-86.el9.x86_64+debug root=UUID=ceba5bd8-a35a-4599-9dee-6f3120630969 ro console=ttyS0,115200 console=tty0 panic=5 net.ifnames=0 biosdevname=0 intel_idle.max_cstate=1 intel_pstate=disable crashkernel=1G-2G:256M,2G-4G:320M,4G-32G:512M,32G-64G:1024M,64G-128G:2048M,128G-:4096M
[Mon Jun 27 15:10:44 2022] Reserving 256MB of memory at 1776MB for crashkernel (System RAM: 2047MB)
[Mon Jun 27 15:10:44 2022] Kernel command line: BOOT_IMAGE=(hd0,msdos1)/boot/vmlinuz-5.14.0-86.el9.x86_64+debug root=UUID=ceba5bd8-a35a-4599-9dee-6f3120630969 ro console=ttyS0,115200 console=tty0 panic=5 net.ifnames=0 biosdevname=0 intel_idle.max_cstate=1 intel_pstate=disable crashkernel=1G-2G:256M,2G-4G:320M,4G-32G:512M,32G-64G:1024M,64G-128G:2048M,128G-:4096M
```

#### Kdump的状态和配置

```
[root@VM-0-8-centos ~]# kdumpctl showmem
kdump: Reserved 256MB memory for crash kernel
[root@VM-0-8-centos ~]# kdumpctl start
kdump: Kdump already running: [WARNING]
[root@VM-0-8-centos ~]# kdumpctl status
kdump: Kdump is operational
[root@VM-0-8-centos crash]# systemctl is-active kdump
active
```

kdump输出vmcore保存路径：/etc/sysconfig/kdump。

```
KDUMP_SAVEDIR=”file:///var/crash”
```

查看内核的启动命令：

```
[root@VM-0-8-centos ~]# cat /proc/cmdline 
BOOT_IMAGE=(hd0,msdos1)/boot/vmlinuz-5.14.0-86.el9.x86_64+debug root=UUID=ceba5bd8-a35a-4599-9dee-6f3120630969 ro console=ttyS0,115200 console=tty0 panic=5 net.ifnames=0 biosdevname=0 intel_idle.max_cstate=1 intel_pstate=disable crashkernel=1G-2G:256M,2G-4G:320M,4G-32G:512M,32G-64G:1024M,64G-128G:2048M,128G-:4096M
```

查看crashkernel内存分配的地址空间

```
[root@VM-0-8-centos ~]# cat /proc/iomem | grep -i crash
  6f000000-7effffff : Crash kernel
```

### 测试验证

使用Magic SysRq来触发system crash。在测试之前先介绍下Magic SysRq其它一些很有用的值，其都输出在/var/log/messages

- `m` - dump information about memory allocation，导出内存分配的信息 （可以用/var/log/message 查看
- `t` - dump thread state information，导出线程状态信息
- `p` - dump current CPU registers and flags，导出当前CPU寄存器信息和标志位的信息
- `c` - intentionally crash the system (useful for forcing a disk or netdump)，故意让系统崩溃
- `s` - immediately sync all mounted filesystems
- `u` - immediately remount all filesystems read-only
- `b` - immediately reboot the machine
- `o` - immediately power off the machine (if configured and supported)
- `f` - start the Out Of Memory Killer (OOM)

执行一次system crash，然后系统重启了。

```
[root@VM-0-8-centos ~]# echo 1 > /proc/sys/kernel/sysrq
[root@VM-0-8-centos ~]# echo c > /proc/sysrq-trigger
Socket error Event: 32 Error: 10053.
Connection closing...Socket close.
```

个人感觉t, p还是挺有用的。

## Kexec

Kexec是一种可以从当前运行的内核引导另一内核的工具。可以准备好系统，以便在系统崩溃的情况下引导进入另一个内核。

该工具非常有用，例如：**保存崩溃内核的转储**。Kexec可以保留物理内存的内容，在生产内核发生故障后，捕获内核（在预留内存范围内运行的附加内核）会保留故障内核的状态。保存的映象可帮助后续分析。

### 组件介绍

最主要的就是/usr/sbin/kexec这个命令，可以通过两种方式使用Kexec装在内核：

- 将内核装载到某个生产内核的地址空间，已进行常规引导：

  ```
  kexec -l KERNEL_IMAGE
  ```

  可以稍后使用kexec -e引导到此内核。

- 将内核装载到预留的内存区域

  ```
  kexec -p KERNEL_IMAGE
  ```

  当系统崩溃时，会自动引导此内核。

所以前面配置的crashkerne指定的内存就是专门给捕获内核使用的，生产内核永远不会装载到此区域，这个参数必须追加到生产内核引导命令行。

## Crash分析

### 安装debug版本内核

```
dnf -y install kernel-debug.x86_64 kernel-debug-core.x86_64 kernel-debug-devel.x86_64
```

crash是一个用于分析内核转储文件的工具，一般配合kdump使用，使用crash时，要求调试内核vmlinux在编译时带有-g选项，用file命令看就是no strip。

## 资料

- [Chapter 48. Installing and configuring kdump Red Hat Enterprise Linux 8 | Red Hat Customer Portal](https://access.redhat.com/documentation/en-us/red_hat_enterprise_linux/8/html/system_design_guide/installing-and-configuring-kdump_system-design-guide)
- [kdump_usage_and_internals.pdf (linuxfound.org)](https://events.static.linuxfound.org/sites/events/files/slides/kdump_usage_and_internals.pdf)
- [Kexec 和 Kdump | 系统分析和微调指南 | SUSE Linux Enterprise Desktop 15 SP3](https://documentation.suse.com/zh-cn/sled/15-SP3/html/SLED-all/cha-tuning-kexec.html)


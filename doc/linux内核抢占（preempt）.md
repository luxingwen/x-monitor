# linux内核抢占（preempt）

## 概念

内核抢占是指用户程序在执行系统调用期间可以被抢占，该进程暂时挂起，使新唤醒的高优先级进程能够运行。

这种抢占并非可以在内核的任意位置都能安全进行，比如在**临界区中的代码**就不能发生抢占。

临界区：是指同一时间内该指令序列只能有一个进程在执行。

内核抢占要求内核中所有可能为一个以上进程共享的变量和数据结构都要通过互斥机制加以保护，都要梵高临界区中。

## 合适的抢占

如果内核不是一个中断处理程序中，并且不在被spinlock等互斥机制保护的临界代码中，就可以“安全”的进行进程切换。

LInux内核抢占只有在内核正在执行例外处理程序（通常指系统调用）并且允许内核抢占时，才能进行抢占内核。

## 禁止抢占

禁止抢占的情况如下：

1. 内核执行中断处理例程时不允许抢占，中断返回时在执行内核抢占。
2. 当内核执行软终端或tasklet时，禁止内核抢占，软中断返回时在执行内核抢占。
3. 在临界区禁止内核抢占，临界区保护函数通过抢占计数宏控制抢占，**计数大于0**，表示禁止内核抢占。

## 抢占实现原理

抢占式内核实现的原理是释放自旋锁时或从中断返回时，如果当前执行进程的need_resched被标记，则进行抢占式调度。

Linux内核在线程信息结构上增加了成员preemt_count作为内核抢占锁，为0表示科技进行内核高度，他随spinlock和rwlock等一起加锁和解锁。

内核调度器的入口为preempt_schedule()，它将当前进程标记为TASK_PREEMPTED状态再调用schedule()，在TASK_PREEMPTED状态，schedule()不会将进程从运行队列中删除。

## 资料

1. [Linux内核抢占机制(preempt) - 知乎 (zhihu.com)](https://zhuanlan.zhihu.com/p/454793333)
2. [详解Linux系统中的内核抢占机制 - 程序员文章站 (superweb999.com)](https://www.superweb999.com/article/1293706.html)
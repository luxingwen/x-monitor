# 内核调试

## kdump

kdump是内核崩溃的时候，用来转存运行内存的一个工具。系统一旦崩溃，内核就没法工作了，这个时候将由kdump提供一个用于捕获当前运行信息的内核，该内核会将此时内存中的所有运行状态和数据信息收集到一个dump core文件中以便之后分析崩溃原因。一旦内存信息收集完成，可以让系统自动重启。

### 工作原理

当内核发生panic时，内核依靠kexec机制在预先保留的内存区域快速重启一个新的内核实例，预留内存区域大小可以通过内核启动参数crashkernel指定。

为了实现双内核布局，kdump在内核崩溃后立即使用kexec引导转储捕获内核（capture kernel），使用kexec引导“覆盖”当前运行的内核。kexec（kernel execution）是linux内核的一种机制，其允许从当前运行的内核启动新内核。kexec会跳过由系统固件执行的引导加载程序阶段和硬件初始化阶段，直接将新内核加载到主内存并立即开始执行。

![kdump原理架构](./kdump原理架构.jpg)

Kdump在内核学习时非常有用，如果我们需要了解内核运行状态或结构详情也可以使用kdump进行转储，后续使用Crash工具对照源码进行分析总结。

### 安装、配置

#### 配置内核启动参数crashkernel

```
[root@VM-0-8-centos bpf-examples]# grubby --update-kernel=/boot/vmlinuz-5.14.0-86.el9.x86_64+debug --args=crashkernel=1G-2G:192M,2G-4G:320M,4G-32G:512M,32G-64G:1024M,64G-128G:2048M,128G-:4096M
```

系统重启后，可以在dmesg中查看相关信息：

```
[root@VM-0-8-centos ~]# dmesg -T | grep -i crash
[Mon Jun 27 15:10:44 2022] Command line: BOOT_IMAGE=(hd0,msdos1)/boot/vmlinuz-5.14.0-86.el9.x86_64+debug root=UUID=ceba5bd8-a35a-4599-9dee-6f3120630969 ro console=ttyS0,115200 console=tty0 panic=5 net.ifnames=0 biosdevname=0 intel_idle.max_cstate=1 intel_pstate=disable crashkernel=1G-2G:256M,2G-4G:320M,4G-32G:512M,32G-64G:1024M,64G-128G:2048M,128G-:4096M
[Mon Jun 27 15:10:44 2022] Reserving 256MB of memory at 1776MB for crashkernel (System RAM: 2047MB)
[Mon Jun 27 15:10:44 2022] Kernel command line: BOOT_IMAGE=(hd0,msdos1)/boot/vmlinuz-5.14.0-86.el9.x86_64+debug root=UUID=ceba5bd8-a35a-4599-9dee-6f3120630969 ro console=ttyS0,115200 console=tty0 panic=5 net.ifnames=0 biosdevname=0 intel_idle.max_cstate=1 intel_pstate=disable crashkernel=1G-2G:256M,2G-4G:320M,4G-32G:512M,32G-64G:1024M,64G-128G:2048M,128G-:4096M
```

#### Kdump的状态和配置

```
[root@VM-0-8-centos ~]# kdumpctl showmem
kdump: Reserved 256MB memory for crash kernel
[root@VM-0-8-centos ~]# kdumpctl start
kdump: Kdump already running: [WARNING]
[root@VM-0-8-centos ~]# kdumpctl status
kdump: Kdump is operational
```

kdump输出vmcore保存路径：/etc/kdump.conf。

```
path /var/crash
```

查看内核的启动命令：

```
[root@VM-0-8-centos ~]# cat /proc/cmdline 
BOOT_IMAGE=(hd0,msdos1)/boot/vmlinuz-5.14.0-86.el9.x86_64+debug root=UUID=ceba5bd8-a35a-4599-9dee-6f3120630969 ro console=ttyS0,115200 console=tty0 panic=5 net.ifnames=0 biosdevname=0 intel_idle.max_cstate=1 intel_pstate=disable crashkernel=1G-2G:256M,2G-4G:320M,4G-32G:512M,32G-64G:1024M,64G-128G:2048M,128G-:4096M
```

查看crashkernel内存分配的地址空间

```
[root@VM-0-8-centos ~]# cat /proc/iomem | grep -i crash
  6f000000-7effffff : Crash kernel
```

### 测试验证

使用Magic SysRq来触发system crash。在测试之前先介绍下Magic SysRq其它一些很有用的值，其都输出在/var/log/messages

- `m` - dump information about memory allocation
- `t` - dump thread state information
- `p` - dump current CPU registers and flags
- `c` - intentionally crash the system (useful for forcing a disk or netdump)
- `s` - immediately sync all mounted filesystems
- `u` - immediately remount all filesystems read-only
- `b` - immediately reboot the machine
- `o` - immediately power off the machine (if configured and supported)
- `f` - start the Out Of Memory Killer (OOM)

执行一次system crash，然后系统重启了。

```
[root@VM-0-8-centos ~]# echo c > /proc/sysrq-trigger
Socket error Event: 32 Error: 10053.
Connection closing...Socket close.
```

## Crash分析
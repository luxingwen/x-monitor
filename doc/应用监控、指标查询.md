# 应用监控、指标查询

## 应用定义

应用可以认为是一个中间件服务、一个数据库服务。应用本身可以是一个进程，也可以是一组进程。x-monitor 收集应用对应的进程指标求和后输出。应用名是唯一的标识，由管理员定义

## 配置过滤规则

应用采集配置在 collector_plugin_appstatus = {}节点中。

1. 基础配置

   1. enable：是否激活应用采集。
   2. update_every：应用指标采集的时间间隔。默认是 1 秒
   3. update_every_for_app：每一条规则对应一个应用，定期使用规则去匹配应用，保证应用启动后在该间隔内被感知到。默认是 10 秒。
   4. update_every_for_filter_rules：规则更新时间间隔，到期读取 filter_sources 的内容，生成应用过滤规则。默认是 30 秒，在编辑了 filter_sources 的文件内容 30 秒后会自动刷新。

2. 过滤源。

   1. filter_sources 配置形式，有两种

      文件列表：filter_sources = "/home/calmwu/program/cpp_space/x-monitor/cli/config_test/db_info_1.txt,/proc/mounts";

      字符串：filter_sources = "/bin/bash /home/calmwu/program/cpp_space/x-monitor/env/plugins.d/timer.plugin 1 -c"

      源里面的数据都按行处理，每一行都表示一个带匹配的数据，程序会使用配置的匹配正则表达式从中提取 app 名字和匹配关键字。

3. 匹配规则。

   filter_regex_pattern：该应用的匹配规则，是正则表达式，通过该表达式在源的每行中匹配出 app 名和匹配关键字。

   appname_match_index：正则表达式匹配出第一个字段是作为应用名字，其余的作为匹配关键字。**应用名不参与应用匹配**。

4. 附加 keys

   additional_keys_str：为了更加精准的匹配到进程，可以在这里添加额外的关键字。多个关键字用逗号分隔。关键字都是用来匹配/proc/pid/cmdline 内容用。

5. 对应进程的方式

   match-keys-for-pid_and_ppid：应用对应进程、子进程。由多进程组成，例如 postgresql。

   match-keys-for-pid：应用对弈一个进程，例如 mysql。

## 应用的指标

### CPU

- app_cpu_usage

  expr：sum(rate(dbapp_cpu_jiffies{app="mysqld", instance="127.0.0.1:31079"}[40s])) by (app, instance) / scalar(count(node_cpu_jiffies{mode="iowait", cpu!="cpu"}))

  说明：应用的 cpu 占用率，应用每秒的 jiffies 除以核数、除以 100。**不同的 dbapp 标签的值不同，例如 dbapp="pgsql"**。

- app_cpu_sys_usage

  expr：sum(rate(dbapp_stime{app="mysqld", instance="127.0.0.1:31079"}[40s]) + rate(app_cstime{app="mysqld", instance="127.0.0.1:31079"}[40s])) by (app, instance) / scalar(count(node_cpu_jiffies{mode="iowait", cpu!="cpu"}))

  说明：应用的 sys 状态 cpu 占用率，百分比，dbapp 填写应用名，instance 填写 endpoint，结果显示为 xxx%

- app_cpu_usr_usage

  expr：sum(rate(app_utime{app="mysqld", instance="127.0.0.1:31079"}[40s]) + rate(app_cutime{app="mysqld", instance="127.0.0.1:31079"}[40s])) by (app, instance) / scalar(count(node_cpu_jiffies{mode="iowait", cpu!="cpu"}))

  说明：应用 usr 态 cpu 占有率，百分比。

### Thread

- app_num_threads

  说明：app 的线程数

### Memory

- dbapp_pss
- dbapp_pss_anon
- dbapp_pss_file
- dbapp_pss_shmem
- dbapp_rss_anon
- dbapp_rss_file
- dbapp_rss_shmem
- dbapp_uss
- dbapp_vmrss
- dbapp_vmsize
- dbapp_vmswap

### 文件句柄

- dbapp_open_fds

### IO
